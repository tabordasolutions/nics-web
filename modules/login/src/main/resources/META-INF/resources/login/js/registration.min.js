var registration=function($){var orgLookupData={};var bInitialized=false;var $formStep1,$formStep2,$formStep3,$formStep4;var $dlgStep1,$dlgStep2,$dlgStep3,$dlgStep4,$dlgConfirmation,$dlgError;var $selectOrgType,$selectOrg,$selectImtUSAR,$selectImtFed,$selectImtCDF,$selectImtLocal;var endpointRoot="";var orgtypesService="organizationTypes";var orgsService="organizations";var termsUrl="login/html/terms.html";var termsElement="#tc_content";function setEndPointRoot(root){endpointRoot=root}function setTermsUrl(url){termsUrl=url}function init(){if(!bInitialized){$formStep1=$("#formStep1");$formStep2=$("#formStep2");$formStep3=$("#formStep3");$formStep4=$("#formStep4");$dlgStep1=$("#step1");$dlgStep2=$("#step2");$dlgStep3=$("#step3");$dlgStep4=$("#step4");$dlgConfirmation=$("#regConfirmation");$dlgError=$("#errordialog");$selectOrgType=$("#selectOrgAffiliates");$selectOrg=$("#selectOrganizations");$selectImtCDF=$("#selectCDFIMT");$selectImtFed=$("#selectFedIMT");$selectImtLocal=$("#selectLocalIMT");$selectImtUSAR=$("#selectUSAR");$($formStep1).validator().on("submit",doStep2);$($formStep2).validator().on("submit",doStep3);$($formStep3).validator().on("submit",doStep4);$($formStep4).validator().on("submit",doRegistration);$($formStep1).on("reset",onResetForm1);$($formStep2).on("reset",onResetForm2);$($formStep3).on("reset",onResetForm3);$($formStep4).on("reset",onResetForm4);$("#tc_content").load(termsUrl+" "+termsElement);$("#phone").mask("(999) 999-9999");populateOrgData();bInitialized=true}}function resetDialogSequence(){$($formStep1)[0].reset();$($formStep2)[0].reset();$($formStep3)[0].reset();$($formStep4)[0].reset();$($dlgStep1).removeClass("hidden");$($dlgStep2).addClass("hidden");$($dlgStep3).addClass("hidden");$($dlgStep4).addClass("hidden");$($dlgConfirmation).addClass("hidden");$($dlgError).addClass("hidden")}function onResetForm1(){setTimeout(function(){$(".selectpicker",$formStep1).selectpicker("render");$("#btnNext1").prop("disabled","disabled")},0)}function onResetForm2(){}function onResetForm3(){setTimeout(function(){$(".selectpicker",$formStep3).selectpicker("render")},0)}function onResetForm4(){setTimeout(function(){$($formStep4).validator("update")},0)}function populateOrgData(){var orgtypesUrl=endpointRoot+orgtypesService;var orgsUrl=endpointRoot+orgsService;$.when($.get(orgtypesUrl),$.get(orgsUrl)).then(function(orgtypesResult,orgsResult){orgLookupData.organizationTypes=createLookup(orgtypesResult[0].organizationTypes);orgLookupData.organizations=createLookup(orgsResult[0].organizations);var sortableOrgTypes=[];for(var orgType in orgLookupData.organizationTypes){sortableOrgTypes.push([orgType,orgLookupData.organizationTypes[orgType]])}sortableOrgTypes.sort(sortobjArrayByName);populateSelect($($selectOrgType),sortableOrgTypes);$($selectOrgType).selectpicker("refresh");populateSelect($($selectImtUSAR),getOrgsData(orgLookupData,"USAR").sort(sortobjArrayByName));$($selectImtUSAR).selectpicker("refresh");populateSelect($($selectImtFed),getOrgsData(orgLookupData,"Federal IMT").sort(sortobjArrayByName));$($selectImtFed).selectpicker("refresh");populateSelect($($selectImtCDF),getOrgsData(orgLookupData,"CDF IMT").sort(sortobjArrayByName));$($selectImtCDF).selectpicker("refresh");populateSelect($($selectImtLocal),getOrgsData(orgLookupData,"Other Local IMT").sort(sortobjArrayByName));$($selectImtLocal).selectpicker("refresh");return true}).fail(function(result,errortext,error){console.log(errortext);console.log(error);$($dlgStep1).addClass("hidden");doError("Failed to get Organization Data from server.");return false});function createLookup(arrIdTypes){var lookup={};arrIdTypes.forEach(function(idType){lookup[idType.id]=idType});return lookup}}function onOrgAffilliatesChanged(){$("#selectOrganizations").removeAttr("disabled");$("#btnNext1").attr("disabled","disabled");filterOrgs($("#selectOrgAffiliates").val())}function onOrgChanged(){console.log($("#selectOrganizations").val());$("#btnNext1").prop("disabled",false)}function filterOrgs(OrgAffiliateId){var organizationIds=orgLookupData.organizationTypes[OrgAffiliateId].organizationIds;var sortableOrgs=[];organizationIds.forEach(function(orgid){sortableOrgs.push([orgid,orgLookupData.organizations[orgid]])});sortableOrgs.sort(sortobjArrayByName);$($selectOrg).empty();populateSelect($($selectOrg),sortableOrgs);$($selectOrg).selectpicker("refresh")}function sortobjArrayByName(a,b){var nameA=a[1].name.toUpperCase();var nameB=b[1].name.toUpperCase();if(nameA<nameB){return-1}if(nameA>nameB){return 1}return 0}function getOrgsData(orgdata,orgTypeName){var orgsData=[];var matches=$.grep(Object.keys(orgdata.organizationTypes),function(orgTypeId){return orgdata.organizationTypes[orgTypeId].name==orgTypeName});if(matches>0){var orgTypeId=matches[0];orgdata.organizationTypes[orgTypeId].organizationIds.forEach(function(orgId){orgsData.push([orgId,orgdata.organizations[orgId]])})}return orgsData}function populateSelect(selectElem,selectData){selectData.forEach(function(item){$(selectElem).append('<option value="'+item[0]+'">'+item[1].name+"</option>")})}function checkForClear(selectobj){if(selectobj.selectedIndex===1){selectobj.selectedIndex=0}}function doStep1(){$($dlgStep2).toggleClass("hidden");$($dlgStep1).toggleClass("hidden")}function doStep2(event){if(event==null||event.target.id=="formStep3"){$($dlgStep3).toggleClass("hidden");$($dlgStep2).toggleClass("hidden")}else{$($dlgStep1).toggleClass("hidden");$($dlgStep2).toggleClass("hidden");$("#firstname").focus();event.preventDefault()}}function doStep3(event){if(event==null||event.target.id=="formStep4"){$($dlgStep4).toggleClass("hidden");$($dlgStep3).toggleClass("hidden")}else{if(!event.isDefaultPrevented()){$($dlgStep2).toggleClass("hidden");$($dlgStep3).toggleClass("hidden");event.preventDefault()}}}function doStep4(event){$($dlgStep3).toggleClass("hidden");$($dlgStep4).toggleClass("hidden");$("#verifyorgname").text($("option:selected",$selectOrg).text());$("#verifyorgtype").text($("option:selected",$selectOrgType).text());$("#verifyemail").text($("#regemail").val());event.preventDefault()}function tcclick(){if($("#chkAgreeTC").prop("checked")==true){$("#termsandconditions").removeClass("errorborder");$("#tchelp").addClass("hidden")}else{$("#termsandconditions").addClass("errorborder");$("#tchelp").removeClass("hidden")}}function doRegistration(event){if(event.isDefaultPrevented()){$("#termsandconditions").addClass("errorborder");$("#tchelp").removeClass("hidden")}else{var postData=createPostData();console.log(JSON.stringify(postData));$($dlgStep4).toggleClass("hidden");$($dlgConfirmation).toggleClass("hidden");event.preventDefault()}}function createPostData(){var teams=[$("#selectCDFIMT").val(),$("#selectFedIMT").val(),$("#selectUSAR").val(),$("#selectLocalIMT").val()];var data={};data.organizationTypeId=$("#selectOrgAffiliates").val();data.organizationId=$("#selectOrganizations").val();data.firstname=$("#firstname").val();data.lastname=$("#lastname").val();data.email=$("#regemail").val();data.password=$("#regpassword").val();data.phone=$("#phone").val();data.teams=teams.filter(function(val){return val!=""});return data}function doError(message){$("#errormessage").text(message);$($dlgError).removeClass("hidden")}return{init:init,resetDialogSequence:resetDialogSequence,onOrgAffilliatesChanged:onOrgAffilliatesChanged,onOrgChanged:onOrgChanged,doStep1:doStep1,doStep2:doStep2,doStep3:doStep3,doStep4:doStep4,doRegistration:doRegistration,doError:doError,checkForClear:checkForClear,setEndPointRoot:setEndPointRoot,setTermsUrl:setTermsUrl,tcclick:tcclick}}(jQuery);